---
title: "3.2_Bayesian_Tasks"
author: "Paul Hazell"
date: "25/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyr)
library(dplyr)
library(RColorBrewer)
library(multcomp)
library(R2jags)
library(ggmcmc)
```

# 3.2 Bayesian Tasks
## 3.2.1 Frequentist One-Way Analysis of Variance
```{r data, include=FALSE}
df_long <- read.csv('./yield_data.csv',header = FALSE)
colnames(df_long) <- c("Fertilizer","Yield","plot_size")
```
__*Part (a) Visualise the Field Yield data*__

  Ordinarily a box-plot would offer a good visualisation of THIS KIND OF DATA however this small data set generates an incoherent box-plot hence the authors have created the following graph instead:
```{r yield_plot, echo=FALSE}
# Part A - Draw me a pretty graph
# Box-plot
ggplot(data=df_long, aes(x=Fertilizer, y=Yield))+
  geom_point(data=df_long,pch=21,alpha=0.5,aes(bg=Fertilizer, size=plot_size))+
  scale_size_continuous(range = c(10,8))+
  ggtitle("Crop yield grouped by fertilizer used")+
  xlab("Fertilizer used")+
  ylab("Crop Yield (ton/hectare)")+
  scale_fill_brewer(palette="Spectral")+
  stat_summary(fun.y = mean,
               colour="darkblue",
               geom = "point",
               shape = 5,
               size = 2.5,
               show.legend = TRUE) +
  stat_summary(fun.y = mean,
               colour = "darkblue",
               geom = "text",
               show.legend = FALSE,
               vjust = -0.75,
               aes(label = round(..y.., digits = 3)))+
  theme(legend.position = "none",
        plot.title =element_text(hjust = 0.5))+
  scale_y_continuous(breaks=seq(0, 9, 1))+
  coord_flip()
```

  In the above plot repeated yield values appear as stacked circles and the mean value for each fertilizer group is given in blue. Our visualisation suggests notable overlap between adjacent fertilizer groups however *f1* could be significantly different to groups *f3* and *f4*.

__*Part (b) Interpretation of the parameter $\alpha$*__

  For a given fertilizer group $\alpha$ represents the difference between a groups mean crop yield and the mean crop yield for group *f1*. If $\alpha$ = 0 for all of our groups then our data suggests that crop yield is NOT affected by the fertilizers that we used.  This means a null hypothesis of there being no difference in crop yield between the fertilizer groups can be articulated as:
  
  $H_0$ : $\alpha_{f2}$ = $\alpha_{f3}$ = $\alpha_{f4}$ = 0
  
__*Part (c) Frequentist ANOVA*__

  To undertake frequentist  ANOVA on our dataset first we utilize the Maximum Likelihood EstimatOR to generate a linear model for crop yield dependant upon fertilizer group.
```{r lm}
yield_lm <- lm(Yield ~ Fertilizer,data = df_long)
```
  From this model we can derive the mean crop yield value for **f1** and the $\alpha$ values for the other groups.
```{r alphas, echo=FALSE}
alphas <- yield_lm$coefficients
names(alphas) <- c("f1_mean","f2_alpha","f3_alpha","f4_alpha")
alphas
```
  The results of an ANOVA test on our linear model returns the following results:
```{r anova}
anova(yield_lm)
```
  If we take a SIZE of 0.05 to be our threshold then our P value of 0.03388 means we can reject our null hypothesis. MORE HERE.
  
__*Part (d) Tukey Honest Significant Differences Test*__

  BLURB - STATE ALL THE HYPOTHESIS
```{r Tukey, include=FALSE}
yield_aov <- aov(Yield ~ Fertilizer,data = df_long)
tukey_results <- TukeyHSD(yield_aov)
tukey_analysis <- tukey_results$Fertilizer[,"p adj"]
```
  The results of our Tukey test are as follows:
```{r Tukey_result, echo=FALSE}
tukey_analysis
```

  Here we see the p-values when directly comparing each of the fertilizer groups in turn. If we filter our results for value that satisfy our TEST OF 0.05 we can see that the only significant difference is between groups *f1* and *f4*
```{r Tukey_filtered, echo=FALSE}
tukey_analysis[which(tukey_analysis < 0.05)]
```

__*Part (e) Is the underlying crop yield level $\mu_4$ obtained using the fourth fertilizer more than 0.5 units greater than the average of the underlying crop yield levels obtained using the other three fertilizers, $\mu_1$ , $\mu_2$ and $\mu_3$ respectively? *__

  In order to answer this question we will look to reject the following null hypothesis:
  
  $H_0$ : $\mu_4$ - $\left(\mu_1 + \mu_2 + \mu_3 / 3 \right) \le 0.5$

  To test $H_0$ we will generate a mean paramterised version of our linear model which we will then be run through a generalised linear hypothesis test along with a description of our null hypothesis.
```{r glht}
yield_lm_mp <- lm(Yield ~ Fertilizer -1, data = df_long)
ght <- glht(yield_lm_mp,linfct="Fertilizerf4 - ((Fertilizerf1 + Fertilizerf2 + Fertilizerf3)/3) <= 0.5")
summary(ght)
```
  Here we can see a p-value of 0.0391 allows to reject our null hypothesis and conclude that the underlying crop yield for Î¼ 4 is more than 0.5 units greater than the average underlying crop yield of the other three groups.
  
  
## 3.2.2 Bayesian One-way Analysis of Variance

__*Part (f) Once way ANOVA using JAGS*__

  The JAGS code we will use to undertake our ANOVA is as follows:
```{r JAGS_data_set_up,include=FALSE}
# Yield values
y <- df_long$Yield
# fertilizer groups - convert group to numeric factor
g1 <- df_long$Fertilizer
g2 <- substr(g1,2,2)
group <-as.factor(as.numeric(g2))
# number of data points
n <- length(y)
# number of groups 
I <- 4
data_anova <- list("y", "group", "n", "I")
```
```{r JAGS_ANOVA}
Bayesian_anova <- function(){
  
  # Likelihood function
  for(k in 1:n){
    y[k] ~ dnorm(mu[k], tau) 
    mu[k] <- m + alpha[group[k]] 
  }
  
  # Priors
  m ~ dnorm(0.0, 0.0001)
  alpha[1] <- 0 
  
  for(i in 2:I){ 
    alpha[i] ~ dnorm(0.0,0.0001)
  }
  
  tau ~ dgamma(0.001,0.001)
  sigma <- 1.0 / sqrt(tau)
  
  # Track Means
  mean_yield[1] = m + alpha[1]
  mean_yield[2] = m + alpha[2]
  mean_yield[3] = m + alpha[3]
  mean_yield[4] = m + alpha[4]
}
```
```{r run_JAGS,include=FALSE}
Bayesian_anova_inference <- jags(data = data_anova, 
                                 parameters.to.save = c("m", 
                                                        "alpha", 
                                                        "sigma", 
                                                        "tau",
                                                        "mean_yield"), 
                                 n.iter = 100000, 
                                 n.chains = 3,
                                 model.file = Bayesian_anova)
```

__*Part (g) Graphical representation of posterior densities*__
  BLURB
  
```{r posterior_plot, echo=FALSE}
mcmc_data <- as.mcmc(Bayesian_anova_inference)
ggs_data <- ggs(mcmc_data)
ggs_density(ggs_data, family = "^alpha")+xlim(-10,10)
```


__*Part (h) 95% Credible Interval Analysis*__

  BLURB - mui first
  
```{r cred_int_mu, echo=FALSE}
ggs_caterpillar(ggs_data,family = "^mean_yield")
```
  BLURB - alpha to re-inforce
```{r cred_int_alpha, echo=FALSE}
ggs_caterpillar(ggs_data,family = "^alpha")
```

__*Part (i) Compare Frequentist and Bayesian 95% confidence intervals*__

  BLURB _ all needs doing
  
__*Part (j) Bayesian analysis of differences in $\alpha_f$*__

  We will use the following JAGS code to infer the posterior distributions for each of the hypotheses laid out in section (c) AND THE UNITS question:
```{r JAGS_alpha_delta}
delta_alpha_model <- function(){
  
  # Likelihood function
  for(k in 1:n){
    y[k] ~ dnorm(mu[k], tau) 
    mu[k] <- m + alpha[group[k]] 
  }
  
  # Priors
  m ~ dnorm(0.0, 0.0001)
  
  for(i in 1:I){ 
    alpha[i] ~ dnorm(0.0,0.0001)
    for (n in 1:(i-1)) {
      AlphaDelta[n,i] <- alpha[n]-alpha[i]
    }
  }
  
  # Variance
  tau ~ dgamma(0.001,0.001)
  sigma <- 1.0 / sqrt(tau)
  
  # Calculate for units...
  Alpha_four_test <- alpha[4] - ((alpha[1] + alpha[2] + alpha[3])/3)
}
```

  The output obtained is as follows:
```{r run_alpha_delta, echo=FALSE}
delta_alpha_inference <- jags(data = data_anova, 
                              parameters.to.save = c("AlphaDelta","Alpha_four_test"), 
                              n.iter = 1000000, 
                              n.chains = 3,
                              model.file = delta_alpha_model)
print(delta_alpha_inference, intervals = c(0.025,0.5,0.975))
```

  BLURB - Some analysis, compare with point (d), use caterpillar plot 
  
## 3.2.3 Simpler Bayesian model

__*Part (k) JAGS code for simple Bayesian model*__

  The JAGS code we will use to infer posterior distributions based upon the given model is as follows:
```{r simple_jags}
simple_bayes_model <- function(){
  
  # Likelihood function
  for(k in 1:n){
    y[k] ~ dnorm(mu[k], tau)
    mu[k] <- fertilizer[group[k]]
  }
  
  # Priors
  for(i in 1:I){ 
    fertilizer[i] ~ dnorm(0.0,0.0001)
  }
  
  tau ~ dgamma(0.001,0.001)
  sigma <- 1.0 / sqrt(tau)
}
```
```{r run_simple_JAGS, include=FALSE}
simple_jags <- jags(data = data_anova, 
                    parameters.to.save = c("fertilizer", 
                                           "sigma", 
                                           "tau"), 
                    n.iter = 100000, 
                    n.chains = 3,
                    model.file = simple_bayes_model)
```

  more BLURB ?
  
__*Part (l) Graphical representations of the simle model*__

  BLURB
```{r plot_simp_post,echo=FALSE}
ggs_simple <- ggs(as.mcmc(simple_jags))
ggs_caterpillar(ggs_simple,family = "^fertilizer")
```

  BLURB - Brief comment
  
__*Part (m) Comparison of Bayesian models*__

  O look - more BLURB 
